<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ƒê·∫†I CHI·∫æN "PH√ÇN L√î B√ÅN N·ªÄN" TP. B·∫¢O L·ªòC - SCP001 üè°</title>
    <style>
      /* --- PH·∫¶N CSS TRANG TR√ç --- */
      body {
        background-color: #121212;
        color: #fff;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        text-align: center;
        margin: 0;
        padding: 20px;
      }
      h1 {
        color: #ffeb3b;
        text-shadow: 2px 2px 0 #000;
        text-transform: uppercase;
        margin-bottom: 5px;
        letter-spacing: 2px;
      }

      /* M√†n h√¨nh ƒëƒÉng nh·∫≠p */
      #login-screen {
        margin-top: 80px;
        transition: all 0.5s;
      }
      input {
        padding: 15px;
        font-size: 20px;
        border-radius: 50px;
        border: 3px solid #ffeb3b;
        background: #333;
        color: white;
        text-align: center;
        width: 80%;
        max-width: 300px;
        outline: none;
      }
      button#start-btn {
        padding: 15px 50px;
        font-size: 20px;
        background: #ff0055;
        color: white;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 20px;
        transition: 0.2s;
        box-shadow: 0 5px 20px rgba(255, 0, 85, 0.5);
      }
      button#start-btn:hover {
        transform: scale(1.1);
        background: #ff3377;
      }

      /* KHU V·ª∞C B·∫¢N ƒê·ªí */
      #game-board {
        display: none;
        max-width: 100%;
        margin: 0 auto;
        animation: fadeIn 1s;
      }

      .map-container {
        /* K√≠ch th∆∞·ªõc b·∫£n ƒë·ªì */
        width: 600px;
        height: 600px;
        margin: 20px auto;
        position: relative;

        /* ·∫¢NH B·∫¢N ƒê·ªí C·ª¶A B·∫†N */
        background-image: url("bando.jpg");
        background-size: cover;
        background-position: center;

        border: 5px solid #fff;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
        border-radius: 15px;
        overflow: hidden;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        grid-template-rows: repeat(6, 1fr);
        width: 100%;
        height: 100%;
      }

      .slot {
        /* Hi·ªáu ·ª©ng k√≠nh m·ªù */
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        user-select: none;
        color: #fff;
        text-shadow: 2px 2px 4px #000;
        position: relative;
      }

      .slot span.num {
        font-size: 32px;
        font-weight: 900;
        opacity: 0.9;
        z-index: 2;
      }
      .slot span.owner {
        font-size: 11px;
        font-weight: bold;
        background: #000;
        color: #fff;
        padding: 2px 6px;
        border-radius: 4px;
        margin-top: 5px;
        z-index: 2;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
      }

      /* Hi·ªáu ·ª©ng khi di chu·ªôt */
      .slot:hover:not(.taken) {
        background: rgba(0, 255, 136, 0.5);
        border: 2px solid #fff;
        z-index: 10;
        transform: scale(1.05);
      }

      /* √î ƒê√É C√ì CH·ª¶ (M√†u ƒê·ªè) */
      .slot.taken {
        background: rgba(220, 20, 60, 0.85) !important;
        cursor: not-allowed;
      }
      .slot.taken span.num {
        display: none;
      } /* ·∫®n s·ªë ƒëi */

      /* √î C·ª¶A M√åNH (M√†u Xanh D∆∞∆°ng) */
      .slot.mine {
        background: rgba(30, 144, 255, 0.85) !important;
        border: 3px solid #fff;
      }

      .status {
        margin-top: 15px;
        font-size: 18px;
        font-weight: bold;
        color: #ffeb3b;
        min-height: 25px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* Mobile Responsive */
      @media (max-width: 650px) {
        .map-container {
          width: 350px;
          height: 350px;
        }
        .slot span.num {
          font-size: 20px;
        }
        input {
          width: 90%;
        }
      }
    </style>
  </head>
  <body>
    <div id="login-screen">
      <h1>üè° ƒê·∫†I CHI·∫æN ƒê·∫§T ƒêAI üè°</h1>
      <p style="color: #bbb; margin-bottom: 30px">
        Nh·∫≠p danh t√≠nh ƒë·∫°i gia ƒë·ªÉ v√†o ch·ªët ƒë∆°n
      </p>
      <input type="text" id="username" placeholder="V√≠ d·ª•: Shark H∆∞ng" />
      <br />
      <button id="start-btn">V√ÄO CH·ª¢ ƒê·∫§T</button>
    </div>

    <div id="game-board">
      <p>
        ƒê·∫°i gia:
        <strong id="display-name" style="color: #00ff88; font-size: 1.2em"
          >...</strong
        >
        | ƒê√£ ch·ªët:
        <span id="count" style="color: #ffeb3b; font-size: 1.5em">0</span>/2 l√¥
      </p>

      <div class="map-container">
        <div class="grid" id="grid"></div>
      </div>

      <div class="status" id="status-msg"></div>
      <p style="color: #555; font-size: 0.8em; margin-top: 30px">
        Game Real-time by Admin
      </p>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
        runTransaction,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

      // ==========================================
      // 1. D√ÅN CONFIG FIREBASE V√ÄO ƒê√ÇY
      // ==========================================
      const firebaseConfig = {
        apiKey: "AIzaSyDlktYhwJpru8aVgcMR5sOEaCVZkSbQaxs",
        authDomain: "gamegiatslot.firebaseapp.com",
        databaseURL: "https://gamegiatslot-default-rtdb.firebaseio.com",
        projectId: "gamegiatslot",
        storageBucket: "gamegiatslot.firebasestorage.app",
        messagingSenderId: "779456135931",
        appId: "1:779456135931:web:64b7522de812e69099a65e",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      let myName = "";
      let mySlots = 0;

      // X·ª≠ l√Ω n√∫t ƒêƒÉng nh·∫≠p
      document.getElementById("start-btn").addEventListener("click", () => {
        const nameInput = document.getElementById("username").value.trim();
        if (!nameInput) {
          alert("Vui l√≤ng nh·∫≠p t√™n ƒë·ªÉ bi·∫øt ai l√† ch·ªß ƒë·∫•t!");
          return;
        }
        myName = nameInput;
        document.getElementById("display-name").textContent = myName;

        // Chuy·ªÉn m√†n h√¨nh
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("game-board").style.display = "block";

        // B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu
        loadSlots();
      });

      // H√†m v·∫Ω √¥ v√† l·∫Øng nghe d·ªØ li·ªáu
      function loadSlots() {
        const grid = document.getElementById("grid");
        grid.innerHTML = "";

        // T·∫°o 36 √¥
        for (let i = 1; i <= 36; i++) {
          let div = document.createElement("div");
          div.className = "slot";
          div.id = `slot-${i}`;
          div.innerHTML = `<span class="num">${i}</span><span class="owner"></span>`;

          // G·∫Øn s·ª± ki·ªán click
          div.addEventListener("click", () => pickSlot(i));
          grid.appendChild(div);
        }

        // L·∫Øng nghe Firebase (Realtime)
        const slotsRef = ref(db, "slots");
        onValue(slotsRef, (snapshot) => {
          const data = snapshot.val() || {};
          let currentMySlots = 0;

          for (let i = 1; i <= 36; i++) {
            const slotDiv = document.getElementById(`slot-${i}`);
            const ownerName = document.querySelector(`#slot-${i} .owner`);

            if (data[i]) {
              // N·∫øu √¥ ƒë√£ c√≥ ng∆∞·ªùi ch·ªçn
              slotDiv.classList.add("taken");
              ownerName.textContent = data[i]; // Hi·ªán t√™n ng∆∞·ªùi ƒë√≥

              // N·∫øu l√† c·ªßa m√¨nh
              if (data[i] === myName) {
                slotDiv.classList.add("mine");
                currentMySlots++;
              } else {
                slotDiv.classList.remove("mine");
              }
            } else {
              // √î tr·ªëng
              slotDiv.classList.remove("taken", "mine");
              ownerName.textContent = "";
            }
          }

          // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng √¥ m√¨nh ƒë√£ ch·ªçn
          mySlots = currentMySlots;
          document.getElementById("count").textContent = mySlots;
        });
      }

      // H√†m x·ª≠ l√Ω khi b·∫•m v√†o √¥ (GI·ª∞T SLOT)
      function pickSlot(slotId) {
        const msgBox = document.getElementById("status-msg");

        // --- KI·ªÇM TRA GI·ªú (LOGIC M·ªöI) ---
        const now = new Date();
        const currentHour = now.getHours();

        // !!! CH√ö √ù: S·ª≠a s·ªë 18 b√™n d∆∞·ªõi th√†nh s·ªë 0 n·∫øu mu·ªën test ngay b√¢y gi·ªù !!!
        if (currentHour < 18) {
          msgBox.textContent = "‚õî Ch∆∞a t·ªõi gi·ªù m·ªü b√°n! 18h quay l·∫°i nh√©.";
          return;
        }
        // ---------------------------------

        if (mySlots >= 2) {
          msgBox.textContent = "‚õî Tham lam qu√°! Ch·ªâ ƒë∆∞·ª£c mua 2 l√¥ th√¥i!";
          return;
        }

        // G·ª≠i l·ªánh l√™n Firebase
        const slotRef = ref(db, `slots/${slotId}`);
        runTransaction(slotRef, (currentData) => {
          // N·∫øu currentData l√† null nghƒ©a l√† √¥ tr·ªëng -> ƒê∆∞·ª£c ghi t√™n
          if (currentData === null) {
            return myName;
          } else {
            return; // ƒê√£ c√≥ ng∆∞·ªùi -> H·ªßy (Abort)
          }
        })
          .then((result) => {
            if (result.committed) {
              msgBox.textContent = "‚úÖ Ch·ªët ƒë∆°n th√†nh c√¥ng!";
              msgBox.style.color = "#00ff88";
            } else {
              msgBox.textContent = "‚ùå Ch·∫≠m tay r·ªìi c∆∞ng ∆°i!";
              msgBox.style.color = "#ff0055";
            }
            // X√≥a th√¥ng b√°o sau 2 gi√¢y
            setTimeout(() => (msgBox.textContent = ""), 2000);
          })
          .catch((err) => {
            console.error(err);
            msgBox.textContent = "‚ö†Ô∏è L·ªói m·∫°ng r·ªìi!";
          });
      }
    </script>
  </body>
</html>
