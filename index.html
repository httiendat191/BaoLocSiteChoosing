<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·∫†I CHI·∫æN PH√ÇN L√î B√ÅN N·ªÄN üè°</title>
    <style>
        /* --- CSS GI·ªÆ NGUY√äN NH∆Ø C≈® --- */
        body { 
            background-color: #121212; 
            color: #fff; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            margin: 0; padding: 20px;
        }
        h1 { color: #ffeb3b; text-shadow: 2px 2px 0 #000; text-transform: uppercase; margin-bottom: 5px; letter-spacing: 2px;}
        
        #login-screen { margin-top: 80px; transition: all 0.5s; }
        
        /* Input nh·∫≠p t√™n */
        input { 
            padding: 15px; font-size: 20px; border-radius: 50px; 
            border: 3px solid #ffeb3b; background: #333; color: white;
            text-align: center; width: 80%; max-width: 300px; outline: none;
            transition: 0.3s;
        }
        /* Class ƒë·ªÉ ·∫©n input khi ch∆∞a ƒë·∫øn gi·ªù */
        input.locked { opacity: 0.5; cursor: not-allowed; border-color: #555; background: #222; }

        button#start-btn { 
            padding: 15px 50px; font-size: 20px; background: #ff0055; color: white;
            border: none; border-radius: 50px; cursor: pointer; font-weight: bold; margin-top: 20px; 
            transition: 0.2s; box-shadow: 0 5px 20px rgba(255, 0, 85, 0.5);
        }
        button#start-btn:hover { transform: scale(1.1); background: #ff3377; }
        
        /* Style cho n√∫t khi b·ªã kh√≥a */
        button#start-btn:disabled {
            background: #555; color: #aaa; cursor: not-allowed;
            transform: none; box-shadow: none;
        }

        #game-board { display: none; max-width: 100%; margin: 0 auto; animation: fadeIn 1s; }
        
        .map-container {
            width: 600px; height: 600px; margin: 20px auto; position: relative;
            background-image: url('bando.jpg'); background-size: cover; background-position: center;
            border: 5px solid #fff; box-shadow: 0 0 30px rgba(0,0,0,0.8); border-radius: 15px; overflow: hidden;
        }

        .grid { display: grid; grid-template-columns: repeat(6, 1fr); grid-template-rows: repeat(6, 1fr); width: 100%; height: 100%; }
        
        .slot {
            background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255,255,255, 0.3);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; user-select: none; color: #fff; text-shadow: 2px 2px 4px #000;
        }
        .slot span.num { font-size: 32px; font-weight: 900; opacity: 0.9; }
        .slot span.owner { font-size: 11px; font-weight: bold; background: #000; color: #fff; padding: 2px 6px; border-radius: 4px; margin-top: 5px; }

        .slot:hover:not(.taken) { background: rgba(0, 255, 136, 0.5); border: 2px solid #fff; z-index: 10; transform: scale(1.05); }
        .slot.taken { background: rgba(220, 20, 60, 0.85) !important; cursor: not-allowed; }
        .slot.taken span.num { display: none; }
        .slot.mine { background: rgba(30, 144, 255, 0.85) !important; border: 3px solid #fff; }
        
        .status { margin-top: 15px; font-size: 18px; font-weight: bold; color: #ffeb3b; min-height: 25px;}
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (max-width: 650px) { .map-container { width: 350px; height: 350px; } .slot span.num { font-size: 20px; } input { width: 90%; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>üè° ƒê·∫†I CHI·∫æN GI√ÄNH √î ƒê·∫§T TP. B·∫¢O L·ªòC - SCP001 üè°</h1>
        <p id="sub-title" style="color:#bbb; margin-bottom: 30px;">Nh·∫≠p danh t√≠nh ƒë·∫°i gia ƒë·ªÉ v√†o ch·ªët ƒë∆°n</p>
        
        <input type="text" id="username" placeholder="V√≠ d·ª•: Shark H∆∞ng" />
        <br>
        <button id="start-btn">V√ÄO MUA ƒê·∫§T</button>
    </div>

    <div id="game-board">
        <p>ƒê·∫°i gia: <strong id="display-name" style="color:#00ff88; font-size: 1.2em;">...</strong> | ƒê√£ ch·ªët: <span id="count" style="color: #ffeb3b; font-size: 1.5em;">0</span>/2 l√¥</p>
        <div class="map-container"><div class="grid" id="grid"></div></div>
        <div class="status" id="status-msg"></div>
        <p style="color: #555; font-size: 0.8em; margin-top: 30px;">Game Real-time by Admin</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // ==========================================
        // D√ÅN CONFIG C·ª¶A B√Ä V√ÄO ƒê√ÇY
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyDlktYhwJpru8aVgcMR5sOEaCVZkSbQaxs",
          authDomain: "gamegiatslot.firebaseapp.com",
          databaseURL: "https://gamegiatslot-default-rtdb.firebaseio.com",
          projectId: "gamegiatslot",
          storageBucket: "gamegiatslot.firebasestorage.app",
          messagingSenderId: "779456135931",
          appId: "1:779456135931:web:64b7522de812e69099a65e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- C·∫§U H√åNH GI·ªú M·ªû C·ª¨A ---
        const OPEN_HOUR = 18; // 18 gi·ªù t·ªëi m·ªõi m·ªü
        // ---------------------------

        let myName = "";
        let mySlots = 0;

        // --- H√ÄM KI·ªÇM TRA GI·ªú NGAY KHI LOAD TRANG ---
        function checkOpeningTime() {
            const now = new Date();
            const currentHour = now.getHours();
            const btn = document.getElementById('start-btn');
            const input = document.getElementById('username');
            const subTitle = document.getElementById('sub-title');

            if (currentHour < OPEN_HOUR) {
                // CH∆ØA ƒê·∫æN GI·ªú -> KH√ìA H·∫æT
                btn.disabled = true;
                btn.textContent = `üîí M·ªû C·ª¨A L√öC ${OPEN_HOUR}H00`;
                
                input.disabled = true;
                input.classList.add('locked');
                input.placeholder = "Ch∆∞a ƒë·∫øn gi·ªù ƒë√¢u c∆∞ng!";
                input.value = ""; // X√≥a n·∫øu c·ªë t√¨nh nh·∫≠p

                subTitle.textContent = `‚õî S√†n giao d·ªãch ƒë√≥ng c·ª≠a. Vui l√≤ng quay l·∫°i l√∫c ${OPEN_HOUR}h00!`;
                subTitle.style.color = "#ff0055";
                
                return false; // Tr·∫£ v·ªÅ false
            } else {
                // ƒê·∫æN GI·ªú -> M·ªû KH√ìA
                return true; // Tr·∫£ v·ªÅ true
            }
        }

        // Ch·∫°y ki·ªÉm tra ngay l·∫≠p t·ª©c khi v√†o web
        checkOpeningTime();

        // X·ª≠ l√Ω n√∫t ƒêƒÉng nh·∫≠p
        document.getElementById('start-btn').addEventListener('click', () => {
            // Ki·ªÉm tra l·∫°i l·∫ßn n·ªØa cho ch·∫Øc (tr√°nh hack HTML)
            if (!checkOpeningTime()) return;

            const nameInput = document.getElementById('username').value.trim();
            if (!nameInput) {
                alert("Vui l√≤ng nh·∫≠p t√™n ƒë·ªÉ bi·∫øt ai l√† ch·ªß ƒë·∫•t!");
                return;
            }
            myName = nameInput;
            document.getElementById('display-name').textContent = myName;
            
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-board').style.display = 'block';
            
            loadSlots();
        });

        function loadSlots() {
            const grid = document.getElementById('grid');
            grid.innerHTML = ""; 

            for (let i = 1; i <= 36; i++) {
                let div = document.createElement('div');
                div.className = 'slot';
                div.id = `slot-${i}`;
                div.innerHTML = `<span class="num">${i}</span><span class="owner"></span>`;
                div.addEventListener('click', () => pickSlot(i));
                grid.appendChild(div);
            }

            const slotsRef = ref(db, 'slots');
            onValue(slotsRef, (snapshot) => {
                const data = snapshot.val() || {};
                let currentMySlots = 0;

                for (let i = 1; i <= 36; i++) {
                    const slotDiv = document.getElementById(`slot-${i}`);
                    const ownerName = document.querySelector(`#slot-${i} .owner`);
                    
                    if (data[i]) {
                        slotDiv.classList.add('taken');
                        ownerName.textContent = data[i];
                        if (data[i] === myName) {
                            slotDiv.classList.add('mine');
                            currentMySlots++;
                        } else {
                            slotDiv.classList.remove('mine');
                        }
                    } else {
                        slotDiv.classList.remove('taken', 'mine');
                        ownerName.textContent = "";
                    }
                }
                mySlots = currentMySlots;
                document.getElementById('count').textContent = mySlots;
            });
        }

        function pickSlot(slotId) {
            // Check gi·ªù l·∫ßn cu·ªëi ·ªü t·∫ßng Logic (B·∫£o m·∫≠t k√©p)
            const now = new Date();
            if (now.getHours() < OPEN_HOUR) {
                 alert("Gian l·∫≠n h·∫£ c∆∞ng? Ch∆∞a ƒë·∫øn gi·ªù!");
                 return;
            }

            const msgBox = document.getElementById('status-msg');
            if (mySlots >= 2) {
                msgBox.textContent = "‚õî Tham lam qu√°! Ch·ªâ ƒë∆∞·ª£c mua 2 l√¥ th√¥i!";
                return;
            }

            const slotRef = ref(db, `slots/${slotId}`);
            runTransaction(slotRef, (currentData) => {
                if (currentData === null) {
                    return myName; 
                } else {
                    return; 
                }
            }).then((result) => {
                if (result.committed) {
                    msgBox.textContent = "‚úÖ Ch·ªët ƒë∆°n th√†nh c√¥ng!";
                    msgBox.style.color = "#00ff88";
                } else {
                    msgBox.textContent = "‚ùå Ch·∫≠m tay r·ªìi c∆∞ng ∆°i!";
                    msgBox.style.color = "#ff0055";
                }
                setTimeout(() => msgBox.textContent = "", 2000);
            }).catch(err => {
                console.error(err);
                msgBox.textContent = "‚ö†Ô∏è L·ªói m·∫°ng r·ªìi!";
            });
        }
    </script>
</body>
</html>
